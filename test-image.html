<!DOCTYPE html>
<html>
<head>
    <title>Test S3 Image Upload</title>
</head>
<body>
    <h1>Test S3 Image Upload</h1>
    
    <form id="postForm">
        <div>
            <label>Title:</label>
            <input type="text" id="title" value="Тест S3 интеграции" required>
        </div>
        <div>
            <label>Body:</label>
            <textarea id="body" required>Этот пост использует S3 для хранения изображений</textarea>
        </div>
        <div>
            <label>Category:</label>
            <select id="category">
                <option value="news">News</option>
                <option value="travel">Travel</option>
                <option value="competition">Competition</option>
                <option value="training">Training</option>
                <option value="events">Events</option>
            </select>
        </div>
        <button type="submit">Create Post</button>
    </form>

    <div id="result"></div>

    <div id="imageUpload" style="display:none;">
        <h2>Upload Images</h2>
        <input type="file" id="imageFiles" multiple accept="image/*">
        <button onclick="uploadImages()">Upload Images</button>
    </div>

    <script>
        let currentPostId = null;

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const postData = {
                title: document.getElementById('title').value,
                body: document.getElementById('body').value,
                category: document.getElementById('category').value
            };

            try {
                const response = await fetch('http://localhost:3001/api/news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData)
                });

                const result = await response.json();
                document.getElementById('result').innerHTML = `<p>Post created with ID: ${result.id}</p>`;
                currentPostId = result.id;
                document.getElementById('imageUpload').style.display = 'block';
            } catch (error) {
                document.getElementById('result').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        });

        async function uploadImages() {
            if (!currentPostId) {
                alert('Create a post first');
                return;
            }

            const files = document.getElementById('imageFiles').files;
            if (files.length === 0) {
                alert('Select images first');
                return;
            }

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            try {
                const response = await fetch(`http://localhost:3001/api/news/${currentPostId}/images`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                document.getElementById('result').innerHTML += `<p>Images uploaded: ${JSON.stringify(result)}</p>`;
                
                // Показываем созданный пост
                showPost();
            } catch (error) {
                document.getElementById('result').innerHTML += `<p>Upload error: ${error.message}</p>`;
            }
        }

        async function showPost() {
            try {
                const response = await fetch(`http://localhost:3001/api/news/${currentPostId}`);
                const post = await response.json();
                
                let html = `<h2>Created Post:</h2>`;
                html += `<h3>${post.title}</h3>`;
                html += `<p>${post.body}</p>`;
                html += `<p>Category: ${post.category}</p>`;
                
                if (post.images && post.images.length > 0) {
                    html += `<h4>Images:</h4>`;
                    post.images.forEach(image => {
                        html += `<div>`;
                        html += `<p>Image: ${image.originalName}</p>`;
                        html += `<p>URL: ${image.url}</p>`;
                        html += `<img src="${image.url}" style="max-width: 300px;" onerror="this.style.border='2px solid red'">`;
                        html += `</div>`;
                    });
                }
                
                document.getElementById('result').innerHTML += html;
            } catch (error) {
                document.getElementById('result').innerHTML += `<p>Error loading post: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>